<h1>IPTABLES Introduction</h1>
In a real-world production environment, there are lots of different clients and many different servers all connected through a large network. With
many different switches and routers, it is important to have network security to allow or restrict access to the various services. This allows us to control
network connectivity, such as allowing SSH access from a specific IP or a network range. We can apply security network-wide using external firewalls or 
appliances such as Cisco ASA, Juniper NGFW, Barracuda NGFW, and Fortinet. Uing these appliances, we can define rules that will control any traffic
flowing through the network. Or, an alternate option is to apply these rules at an individual server level using tool such as IPTABLEs and firewalld in linux
systems and firewall in windows server. 

To install iptable, use the command
 ```console
 $ sudo apt install iptables
 ```
Once iptables is installed, run command to list the default rules configured in the system
 ```console
 $ # list default rules configured in the system
 $ sudo iptables -L

 Chain INPUT (policy ACCEPT)
 target         prot opt source             destination

 Chain Forward (policy ACCEPT)
 target         prot opt source             destination

 Chain OUTPUT (policy ACCEPT)
 target         prot opt source             destination
 ```
 The INPUT Chain is applicable to network packets coming into the system. To allow the SSH connection from the client laptop, we need to add an input role on the devapp server permitting SSH connection.

 The OUTPUT Chain is responsible for connections initiated by the server to other systems. Manages all network packets generated locally bt the server that are destined to leave the system. 

 The FORWARD Chain: network packages coming into the linux server that are to be routed out through another network interface on the server. This rule is not commonly used in a linux server. 

 Since we have not added any rules, the default policy is set to accept. It means that all traffic is allowed in and out of the system. 

 They are called chains becausse each chain can have multiple rules within it. It is a chain of rules. Each rule performs a check and accepts or drops the packet based on the condition. 

 <h3>IPTABLES- Securing the Environment</h3>
 For instance, lets add an incoming or an input rule on the dev server (172.16.238.10) that will allow SSH connection from the client laptop. (172.16.238.187)
  ```console
  $ iptables -A INPUT -p tcp -s 172.16.238.187 --dport 22 -j ACCPET
  ```

  ```console
  $ # what each of the options respresent

  OPTIONS                       DESCRIPTION
  -A                            Add Rule
  -p                            Protocol
  -s                            Source
  -d                            Destination
  --dport                       Destination port
  -j                            Action to take
  ```
  ```console
  $ # shows the rules listed
  $ iptable -L
  Chain INPUT (policy ACCEPT)
  target    prot opt source             destination
  ACCEPT    tcp -- 172.16.238.187       anywhere            tcp dpt:ssh
  ```
  ```console
  $ # adding another input rule to drop other traffic
  $ iptables -A INPUT -p tcp --dport 22 -j DROP
  
  $ iptable -L
  Chain INPUT (policy ACCPET)
  target    prot opt source             destination
  ACCEPT    tcp -- 172.16.238.187       anywhere            tcp dpt: ssh   
  DROP      tcp -- anywhere             anwhere             tcp dpt: ssh
  ```
Now that we have created rules for chain INPUT, the only packets that are being accepted is coming from 172.16.238.187 and other SSH connection attempts from other servers will be dropped.
If we were to add another rule now, it will be added to the bottom of the chain. 

SOURCE / DESTINATION                            ACTION
devdb01                                         Allow outgoing connection to port 5432
caleston-repo-01                                Allow outgoing connection to port 80
Internet                                        Drop all outgoing connections, port 80/443 (HTTP/HTTPS)
caleston-lp10                                   Allow incoming on port 80

 ```console
 $ # devb01 Allowing outgoing connection to port 5432

 $ iptables -A OUTPUT -p tcp -s 172.16.238.11 --dport 5432 -j ACCEPT
 ```

 ```console
 $ # caleston-repo-01 Allowing outgoing connection to port 80

 $ iptables -A OUTPUT -p tcp -s 172.16.238.15 --dport 80 -j ACCEPT
 ```

 ```console
 $ # internet Drop all outgoing connections, port 80/443 (HTTP/HTTPS)

 $ iptable -A OUTPUT -p tcp --dport 80 -j DROP
 $ iptable -A OUTPUT -p tcp --dport 443 -j DROP
 ```

 ```console
 $ # caleston-lp10 Allow incoming on port 80
 $ iptables - A INPUT -p tcp -s 172.16.238.187 --dport 80 -j ACCEPT
 ```
 ```console
 $ # shows all the new rules added
 $ iptables -L
 Chain INPUT (policy ACCEPT)
 target     prot opt source         destination
 ACCEPT      tcp -- 172.16.238.187   anywhere        tcp dpt:ssh
 DROP        tcp -- anywhere         anywhere        tcp dpt:ssh
 ACCEPT      tcp -- 172.16.238.187   anywhere        tcp dpt:http

 Chain FORWARD (policy ACCEPT)
 target     prot opt source         destination

 Chain OUTPUT (policy ACCPET)
 target     prot opt source         destination
 ACCEPT     tcp  --  anywhere       devdb01          tcp dpt:postgresp1
 ACCEPT     tcp  --  anywhere       172.16.238.15    tcp dpt:http
 DROP       tcp  --  anywhere       anywhere         tcp dpt:http
 DROP       tcp  --  anywhere       anywhere         tcp dpt:https   
 ```
Let say we need to access the site caleston-hq.com using HTTPs from devapp-01 server. 
```console
$ # since we have an outbound drop rule for anywhere on port 443, we cant access the site 

$ iptables -L
$ # Chain OUTPUT (policy ACCEPT)
$ # target     prot opt source         destination
$ # ACCEPT     tcp  --  anywhere       devdb01          tcp dpt:postgresp1
$ # ACCEPT     tcp  --  anywhere       172.16.238.15    tcp dpt:http
$ # DROP       tcp  --  anywhere       anywhere         tcp dpt:http
$ * DROP       tcp  --  anywhere       anywhere         tcp dpt:https *
```
To fix this, we need to add another accept output rule above the drop rule at number 4

```console
$ # adding another rule above another rule 
$ iptable -I output -p tcp - 172.16.238.100 --dport 443 -j ACCEPT
- I inserts the rule to the top of the chain instead of the bottom.
- D use the IP address of the target with the -D 
```

```console
 $ iptables -L
 $ # Chain OUTPUT (policy ACCEPT)
 $ # target     prot opt source         destination
 $ * ACCEPT     tcp  --  anywhere       caleston.hq      tcp dpt:https *
 $ # ACCEPT     tcp  --  anywhere       devdb01          tcp dpt:postgresp1
 $ # ACCEPT     tcp  --  anywhere       172.16.238.15    tcp dpt:http
 $ # DROP       tcp  --  anywhere       anywhere         tcp dpt:http
 $ # DROP       tcp  --  anywhere       anywhere         tcp dpt:https 
```
```console
$ # to delete a rule
$ iptables -D OUTPUT 5
```
```console
$ # only accepting packages from one server
$ iptables -A INPUT -p tcp -s 172.16.238.10 --dport 5432 -j ACCEPT
$ iptables -A INPUT -P tcp --dport 5432 -j DROP
```
NETSTAT command is used for monitoring network connections, viewing routing tables, and displaying interface statistics on linux system

```console
$ netstat -an | grep 5432
tcp        0       0 172.15.238.10.44060       172.16.238.11:5432      ESTABLISHED
$ # port 44060 is ephemeral, the connections will not always use the same port
$ # any port between 32768 - 60999 can be used 
```
-a : show all sockets, listening, established, waiting,etc

-n : show numeric addresses and port
    instead of localhost:http-alt
    it will be 127.0.0.1:5432
